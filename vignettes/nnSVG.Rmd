---
title: "nnSVG package"
author: 
  - name: Lukas M. Weber
    affiliation: &id1 "Johns Hopkins Bloomberg School of Public Health, Baltimore, USA"
  - name: Stephanie C. Hicks
    affiliation: &id1
package: nnSVG
output: 
  BiocStyle::html_document
vignette: >
  %\VignetteIndexEntry{nnSVG package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


# Introduction

`nnSVG` is a method for scalable identification of spatially variable genes (SVGs) in spatially resolved transcriptomics (ST) data.

The method is based on nearest-neighbor Gaussian processes ([Datta et al. (2016)](https://www.tandfonline.com/doi/full/10.1080/01621459.2015.1044091)) and uses the BRISC algorithm ([Saha and Datta (2018)](https://onlinelibrary.wiley.com/doi/full/10.1002/sta4.184)).

`nnSVG` allows identification and ranking of SVGs with flexible spatial bandwidths across a tissue slide or within spatial domains defined by covariates. The method scales linearly with the number of spatial locations and can be applied to datasets containing thousands or more spatial locations.

For more details on the method, see our paper.


# Tutorial

## Run nnSVG

Here we show a short example demonstrating how to use `nnSVG`.

For faster runtime in this example, we subsample the dataset and run `nnSVG` on only a small number of genes. For a full analysis, the subsampling step can be skipped.

```{r, message=FALSE}
library(SpatialExperiment)
library(STexampleData)
library(scry)
library(nnSVG)
library(ggplot2)
```

```{r}
# load example dataset from STexampleData package
spe <- Visium_humanDLPFC()

dim(spe)
```

```{r}
# preprocessing steps

# keep only spots over tissue
spe <- spe[, colData(spe)$in_tissue == 1]
dim(spe)

# calculate deviance residuals using scry package
# (alternatively could calculate log-transformed normalized counts)
spe <- nullResiduals(spe, assay = "counts", 
                     fam = "binomial", type = "deviance")

assayNames(spe)
```

```{r}
# select small set of random genes and several known SVGs for faster runtime 
# in this example
set.seed(123)
ix_20 <- sample(seq_len(nrow(spe)), 20)

known_genes <- c("MOBP", "PCP4", "SNAP25", "HBB", "IGKC", "NPY")
ix_known <- which(rowData(spe)$gene_name %in% known_genes)

ix <- c(ix_20, ix_known)

spe <- spe[ix, ]
dim(spe)
```

```{r}
# run nnSVG

# set seed for reproducibility
set.seed(123)
# using default gene filtering parameters and a single thread
spe <- nnSVG(spe)

# show results
rowData(spe)
```


## Investigate results

The results are stored in the `rowData` of the `SpatialExperiment` object, as shown above.

The main results of interest are:

- `LR_stat`: likelihood ratio (LR) statistics
- `rank`: rank of top SVGs according to LR statistics
- `padj`: p-values (adjusted for multiple testing), which can be used to define a cutoff for significant SVGs (e.g. `padj` <= 0.05)
- `prop_sv`: effect size, defined as proportion of spatial variance out of total variance

```{r}
# number of significant SVGs
table(rowData(spe)$padj <= 0.05)
```

```{r}
# show results for top n SVGs
rowData(spe)[rowData(spe)$rank <= 5, ]
```

```{r, fig.width=4, fig.height=3.5}
# plot expression of top-ranked SVG
ix <- which(rowData(spe)$rank == 1)
ix_name <- rowData(spe)$gene_name[ix]
ix_name

df <- as.data.frame(
  cbind(spatialCoords(spe), 
        expr = counts(spe)[ix, ]))

ggplot(df, aes(x = x, y = y, color = expr)) + 
  geom_point(size = 0.4) + 
  coord_fixed() + 
  scale_y_reverse() + 
  scale_color_gradient(low = "gray90", high = "blue") + 
  ggtitle(ix_name) + 
  theme_bw() + 
  theme(panel.grid = element_blank(), 
        axis.title = element_blank(), 
        axis.text = element_blank(), 
        axis.ticks = element_blank())
```


# Session information

```{r}
sessionInfo()
```

