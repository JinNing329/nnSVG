---
title: "nnSVG package"
author: 
  - name: Lukas M. Weber
    affiliation: &id1 "Johns Hopkins Bloomberg School of Public Health, Baltimore, USA"
  - name: Stephanie C. Hicks
    affiliation: &id1
package: nnSVG
output: 
  BiocStyle::html_document
vignette: >
  %\VignetteIndexEntry{nnSVG package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


# Introduction

`nnSVG` is a method for scalable identification of spatially variable genes (SVGs) in spatially resolved transcriptomics data.

The method is based on nearest neighbor Gaussian processes ([Datta et al. (2016)](https://www.tandfonline.com/doi/full/10.1080/01621459.2015.1044091)) and uses the BRISC algorithm ([Saha and Datta (2018)](https://onlinelibrary.wiley.com/doi/full/10.1002/sta4.184)).

`nnSVG` allows identification and ranking of SVGs across the full set of spatial locations (e.g. the whole tissue slide) or within spatial domains defined by known covariates.

The method scales linearly with the number of spatial locations and can be applied to datasets containing thousands of spatial locations.


# Tutorial

## Run nnSVG

Here we show a short example demonstrating how to use `nnSVG`.

For faster runtime in this example, we subsample the dataset after gene filtering to contain only a small number of genes. For a full analysis, the subsampling step can be skipped.

```{r, message=FALSE}
library(SpatialExperiment)
library(STexampleData)
library(nnSVG)
library(ggplot2)
```

```{r}
# load example dataset
spe <- Visium_humanDLPFC()

dim(spe)
```

```{r}
# preprocessing steps

# set seed for reproducibility
set.seed(123)

spe <- preprocessSVG(spe)

dim(spe)
```

```{r}
# subsampling to select small number of random genes and one known SVG for 
# faster runtime in example
set.seed(123)
ix_20 <- sample(seq_len(nrow(spe)), 20)
ix_snap25 <- which(rowData(spe)$gene_name == "SNAP25")
ix <- c(ix_20, ix_snap25)

spe <- spe[ix, ]
dim(spe)
```

```{r}
# run nnSVG

# note: gene filtering was already performed above, so we disable it here
spe <- nnSVG(spe, filter_genes = FALSE, filter_mito = FALSE, n_threads = 1)

# show results
rowData(spe)
```


## Investigate results

The results are stored in the `rowData` of the `SpatialExperiment` object, as shown above.

The main results of interest are:

- `LR_stat`: likelihood ratio (LR) statistics
- `rank`: rank of top SVGs according to LR statistics
- `padj`: p-values (adjusted for multiple testing), which can be used to define a cutoff for significant SVGs (e.g. `padj` <= 0.05)
- `prop_sv`: effect size, defined as proportion of spatial variance out of total variance

```{r}
# number of significant SVGs
table(rowData(spe)$padj <= 0.05)
```

```{r}
# show results for top n SVGs
rowData(spe)[rowData(spe)$rank <= 5, ]
```

```{r, fig.width=4, fig.height=3.5}
# plot expression of top SVG
ix <- which(rowData(spe)$rank == 1)
ix_name <- rowData(spe)$gene_name[ix]
ix_name

df <- as.data.frame(
  cbind(spatialCoords(spe), 
        expr = counts(spe)[ix, ]))

ggplot(df, aes(x = x, y = y, color = expr)) + 
  geom_point(size = 0.4) + 
  coord_fixed() + 
  scale_y_reverse() + 
  scale_color_gradient(low = "gray90", high = "blue") + 
  ggtitle(ix_name) + 
  theme_bw() + 
  theme(panel.grid = element_blank(), 
        axis.title = element_blank(), 
        axis.text = element_blank(), 
        axis.ticks = element_blank())
```


# Session information

```{r}
sessionInfo()
```

